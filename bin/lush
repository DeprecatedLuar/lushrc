#!/usr/bin/env bash
# lush - lushrc management utility

set -euo pipefail

BASHRC="${BASHRC:-$HOME/.config/lushrc}"
SYS_BIN="$HOME/bin/sys"

case "${1:-help}" in
    root)
        [[ -z "$2" ]] && { echo "Usage: lush root <program> [program2...]"; exit 1; }
        shift
        for prog in "$@"; do
            bin=$(command -v "$prog" 2>/dev/null)
            if [[ -z "$bin" ]]; then
                echo "$prog: not found"
                continue
            fi
            mkdir -p "$SYS_BIN"
            ln -sf "$bin" "$SYS_BIN/$prog"
            echo "$prog -> $SYS_BIN/"
        done
        "$LIBDIR/reload.sh" -s
        ;;

    update)
        cd "$BASHRC" || exit 1

        # Check for local changes
        if ! git diff --quiet HEAD 2>/dev/null; then
            echo "Local changes detected:"
            git status --short
            echo
            read -rp "Discard changes and update? [y/N] " answer
            [[ "$answer" =~ ^[Yy]$ ]] || { echo "Aborted."; exit 1; }
            git reset --hard HEAD
        fi

        git pull
        "$LIBDIR/reload.sh"
        ;;

    status)
        cd "$BASHRC" || exit 1
        git status --short
        ;;

    version)
        cd "$BASHRC" || exit 1
        echo "lushrc @ $(git rev-parse --short HEAD) ($(git log -1 --format='%cr'))"
        ;;

    help|*)
        cat << 'EOF'
lush - lushrc management

Commands:
  root <prog>  - Symlink to ~/bin/sys for sudo access
  update       - Pull latest from remote
  status       - Show local changes
  version      - Show current version
  help         - Show this message
EOF
        ;;
esac
