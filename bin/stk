#!/usr/bin/env bash
# stk - Steam game launcher with auto-generated wrapper scripts

WRAPPER_DIR="$HOME/.local/share/stk/wrappers"
SYMLINK_DIR="$HOME/.local/bin"

# Auto-detect Steam installation
detect_steam_root() {
    for path in \
        "$HOME/.local/share/Steam" \
        "$HOME/.steam/steam" \
        "$HOME/.var/app/com.valvesoftware.Steam/.local/share/Steam"; do
        if [[ -d "$path/steamapps" ]]; then
            echo "$path"
            return 0
        fi
    done
    return 1
}

STEAM_ROOT="${STEAM_ROOT:-$(detect_steam_root)}"

if [[ -z "$STEAM_ROOT" ]] || [[ ! -d "$STEAM_ROOT/steamapps" ]]; then
    echo "Error: Steam installation not found. Set STEAM_ROOT env variable if using custom location."
    exit 1
fi

# Parse game info from manifest files
list_games() {
    local appid name
    for manifest in "$STEAM_ROOT/steamapps"/appmanifest_*.acf; do
        [[ ! -f "$manifest" ]] && continue

        appid=$(grep -m1 '"appid"' "$manifest" | sed 's/.*"appid"[[:space:]]*"\([0-9]*\)"/\1/')
        name=$(grep -m1 '"name"' "$manifest" | sed 's/.*"name"[[:space:]]*"\(.*\)"/\1/')

        # Skip runtime/tools
        case "$name" in
            "Steam Linux Runtime"*|"Proton"*|"Steamworks Common Redistributables")
                continue
                ;;
        esac

        echo "$appid|$name"
    done | sort -t'|' -k2
}

# Generate initials from name
get_initials() {
    local name="$1"
    # Remove apostrophes and special chars, split on spaces, take first letter of each word
    echo "$name" | tr -d "'" | sed 's/[^a-zA-Z0-9 ]//g' | awk '{for(i=1;i<=NF;i++) printf tolower(substr($i,1,1))}'
}

# Generate slug from name
get_slug() {
    local name="$1"
    # Remove apostrophes first, then convert to slug
    echo "$name" | tr -d "'" | tr '[:upper:]' '[:lower:]' | sed "s/[^a-z0-9]/-/g" | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//'
}

# Create a single wrapper script and symlink
create_wrapper() {
    local name="$1"
    local appid="$2"
    local wrapper_path="$WRAPPER_DIR/$name"
    local symlink_path="$SYMLINK_DIR/$name"

    # Create wrapper script
    cat > "$wrapper_path" <<EOF
#!/usr/bin/env bash
# stk-generated
exec steam -applaunch $appid "\$@"
EOF
    chmod +x "$wrapper_path"

    # Create symlink
    ln -sf "$wrapper_path" "$symlink_path"
}

# Create wrapper scripts and symlinks
init_wrappers() {
    # Ensure directories exist
    mkdir -p "$WRAPPER_DIR"
    mkdir -p "$SYMLINK_DIR"

    # Get list of current games
    local current_wrappers=()
    while IFS='|' read -r appid name; do
        local initials=$(get_initials "$name")
        local slug=$(get_slug "$name")

        # Only create initials wrapper if it's 2+ characters
        if [[ ${#initials} -ge 2 ]]; then
            current_wrappers+=("$initials")
        fi
        current_wrappers+=("$slug")
    done < <(list_games)

    # Clean up old wrappers that don't exist in current games
    if [[ -d "$WRAPPER_DIR" ]]; then
        for wrapper in "$WRAPPER_DIR"/*; do
            [[ ! -f "$wrapper" ]] && continue
            local basename=$(basename "$wrapper")
            local found=0
            for current in "${current_wrappers[@]}"; do
                if [[ "$basename" == "$current" ]]; then
                    found=1
                    break
                fi
            done
            if [[ $found -eq 0 ]]; then
                rm -f "$wrapper"
                rm -f "$SYMLINK_DIR/$basename"
            fi
        done
    fi

    # Remove broken symlinks in SYMLINK_DIR
    for link in "$SYMLINK_DIR"/*; do
        [[ -L "$link" ]] && [[ ! -e "$link" ]] && rm -f "$link"
    done

    # Create wrappers and symlinks for current games
    local count=0
    while IFS='|' read -r appid name; do
        local initials=$(get_initials "$name")
        local slug=$(get_slug "$name")

        # Create initials wrapper if 2+ characters
        if [[ ${#initials} -ge 2 ]]; then
            create_wrapper "$initials" "$appid"
            ((count++))
        fi
        # Create slug wrapper
        create_wrapper "$slug" "$appid"
        ((count++))
    done < <(list_games)

    echo "Generated $count Steam wrapper scripts in $WRAPPER_DIR"
}

# Auto-refresh wrappers on every run
init_wrappers

# List games
echo ""
echo "Available games:"
list_games | while IFS='|' read -r appid name; do
    echo "  $name"
done
