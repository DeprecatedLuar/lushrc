#!/usr/bin/env bash
# pack - Universal archive creator

KEEP_ORIGINAL=false
TARGET=""
FORMAT=""

for arg in "$@"; do
  case "$arg" in
    -c|--copy)
      KEEP_ORIGINAL=true
      ;;
    -*)
      echo "Error: Unknown option: $arg"
      exit 1
      ;;
    .*)
      if [ -e "$arg" ]; then
        if [ -z "$TARGET" ]; then
          TARGET="$arg"
        else
          FORMAT="$arg"
        fi
      else
        FORMAT="$arg"
      fi
      ;;
    *)
      if [ -z "$TARGET" ]; then
        TARGET="$arg"
      elif [ -z "$FORMAT" ]; then
        FORMAT="$arg"
      else
        echo "Error: Too many arguments"
        exit 1
      fi
      ;;
  esac
done

if [ -z "$TARGET" ]; then
  echo "Usage: pack [-c] <file_or_folder> [.extension]"
  echo "  -c, --copy    Keep original file/folder (default: remove)"
  echo ""
  echo "Supported formats:"
  echo "  .tar.gz, .tgz       Gzip compressed tar (default)"
  echo "  .tar.bz2, .tbz2     Bzip2 compressed tar"
  echo "  .tar.xz, .txz       XZ compressed tar"
  echo "  .tar                Uncompressed tar"
  echo "  .zip                ZIP archive"
  echo "  .bacpac             ZIP (SQL Server format)"
  echo "  .kra                ZIP (Krita format)"
  echo "  .7z                 7-Zip archive"
  exit 1
fi

if [ ! -e "$TARGET" ]; then
  echo "Error: File or folder not found: $TARGET"
  exit 1
fi

if [ -z "$FORMAT" ]; then
  FORMAT=".tar.gz"
fi

FORMAT="${FORMAT#.}"

BASENAME=$(basename "$TARGET")
ORIGINAL_DIR=$(pwd)
OUTPUT="${BASENAME}.${FORMAT}"

case "$FORMAT" in
  tar.gz|tgz)
    PACK_CMD="tar czf"
    ;;
  tar.bz2|tbz2)
    PACK_CMD="tar cjf"
    ;;
  tar.xz|txz)
    PACK_CMD="tar cJf"
    ;;
  tar)
    PACK_CMD="tar cf"
    ;;
  zip|bacpac|kra)
    PACK_CMD="zip"
    ;;
  7z)
    PACK_CMD="7z"
    ;;
  *)
    echo "Error: Unsupported format: .$FORMAT"
    echo "Run 'pack' without arguments to see supported formats"
    exit 1
    ;;
esac

TEMP_DIR=""
TEMP_TARGET=""
PACK_PID=""
SUCCESS=false

cleanup() {
    if [ -n "$PACK_PID" ] && kill -0 $PACK_PID 2>/dev/null; then
        kill $PACK_PID 2>/dev/null
        wait $PACK_PID 2>/dev/null
    fi

    if [ "$KEEP_ORIGINAL" = false ] && [ -n "$TEMP_DIR" ] && [ -d "$TEMP_DIR" ]; then
        if [ "$SUCCESS" = false ] && [ -e "$TEMP_TARGET" ]; then
            mv "$TEMP_TARGET" "$ORIGINAL_DIR/" 2>/dev/null
        fi
        rm -rf "$TEMP_DIR"
    fi
}

trap cleanup INT TERM EXIT

if [ "$KEEP_ORIGINAL" = false ]; then
    TEMP_DIR=$(mktemp -d)
    TEMP_TARGET="$TEMP_DIR/$BASENAME"
    mv "$TARGET" "$TEMP_TARGET"
    TARGET="$TEMP_TARGET"
fi

printf "Packing"

case "$PACK_CMD" in
  tar*)
    $PACK_CMD "$ORIGINAL_DIR/$OUTPUT" -C "$(dirname "$TARGET")" "$(basename "$TARGET")" &
    ;;
  zip)
    (cd "$(dirname "$TARGET")" && zip -rq "$ORIGINAL_DIR/$OUTPUT" "$(basename "$TARGET")") &
    ;;
  7z)
    (cd "$(dirname "$TARGET")" && 7z a -bd "$ORIGINAL_DIR/$OUTPUT" "$(basename "$TARGET")" > /dev/null) &
    ;;
esac

PACK_PID=$!
DOTS=""
while kill -0 $PACK_PID 2>/dev/null; do
    printf "\rPacking%-3s" "$DOTS"
    DOTS="${DOTS}."
    if [ ${#DOTS} -gt 3 ]; then DOTS=""; fi
    sleep 0.3
done
wait $PACK_PID
PACK_EXIT=$?

if [ $PACK_EXIT -ne 0 ]; then
    printf "\rPacking failed\n"
    exit 1
fi

SUCCESS=true
printf "\rDone        \n"
