#!/usr/bin/env bash
# fpk - Simple flatpak launcher with auto-generated wrapper scripts

WRAPPER_DIR="$HOME/.local/share/fpk/wrappers"
SYMLINK_DIR="$HOME/.local/bin"

list_apps() {
    flatpak list --app --columns=application | sort
}

get_suffix() {
    echo "${1##*.}"
}

create_wrapper() {
    local name="$1" app="$2"
    cat > "$WRAPPER_DIR/$name" <<EOF
#!/usr/bin/env bash
# fpk-generated
exec flatpak run $app "\$@"
EOF
    chmod +x "$WRAPPER_DIR/$name"
    ln -sf "$WRAPPER_DIR/$name" "$SYMLINK_DIR/$name"
}

init_wrappers() {
    mkdir -p "$WRAPPER_DIR" "$SYMLINK_DIR"

    # Collect current suffixes
    local current_names=()
    while read -r app; do
        local suffix="${app##*.}"
        current_names+=("${suffix,,}")
    done < <(list_apps)

    # Clean up stale wrappers
    for wrapper in "$WRAPPER_DIR"/*; do
        [[ ! -f "$wrapper" ]] && continue
        local name=$(basename "$wrapper")
        local found=0
        for current in "${current_names[@]}"; do
            [[ "$name" == "$current" ]] && found=1 && break
        done
        if [[ $found -eq 0 ]]; then
            rm -f "$wrapper" "$SYMLINK_DIR/$name"
        fi
    done

    # Create wrappers
    while read -r app; do
        local suffix="${app##*.}"
        create_wrapper "${suffix,,}" "$app"
    done < <(list_apps)
}

# Auto-refresh wrappers
init_wrappers

case "${1:-}" in
    "")
        # No args: list all suffixes
        list_apps | while read -r app; do
            echo "${app##*.}" | tr '[:upper:]' '[:lower:]'
        done | sort -u
        ;;
    *)
        # Search for matching app (case-insensitive)
        target="${1,,}"
        match=""
        while read -r app; do
            suffix="${app##*.}"
            if [[ "${suffix,,}" == "$target" ]]; then
                if [[ -n "$match" ]]; then
                    echo "Error: Multiple matches found:"
                    echo "  $match"
                    echo "  $app"
                    exit 1
                fi
                match="$app"
            fi
        done < <(list_apps)

        if [[ -z "$match" ]]; then
            echo "Error: No flatpak found matching '$1'"
            exit 1
        fi

        shift
        exec flatpak run "$match" "$@"
        ;;
esac
