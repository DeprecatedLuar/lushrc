#!/usr/bin/env bash
# tx (taxi) - quick directory navigation and file transport

# Parse flags
NAV_FLAGS=""
while [[ "$1" == --* ]]; do
    case "$1" in
        --log) NAV_FLAGS="--log"; shift ;;
        *) shift ;;
    esac
done

if [[ $# -ge 2 ]]; then
    # Move file(s): last arg is destination, all others are sources
    dest="${!#}"
    dest_resolved="$($LIBDIR/nav-engine.sh $NAV_FLAGS "$dest")" || return 1

    sources=()
    for ((i=1; i<$#; i++)); do
        src="${!i}"

        # Handle glob patterns (e.g., d/*, t/foo/*)
        if [[ "$src" == */* ]] && [[ "$src" =~ [*?] ]] && [[ ! -e "$src" ]]; then
            base_query="${src%%/*}"
            pattern="${src#*/}"

            # Resolve base path
            base_resolved="$($LIBDIR/nav-engine.sh $NAV_FLAGS "$base_query")" || return 1

            # Expand glob in resolved path
            shopt -s nullglob
            expanded=("$base_resolved"/$pattern)
            shopt -u nullglob

            if [[ ${#expanded[@]} -eq 0 ]]; then
                echo "tx: no matches found for '$src'" >&2
                return 1
            fi

            sources+=("${expanded[@]}")
        else
            # Normal path resolution
            src_resolved="$($LIBDIR/nav-engine.sh $NAV_FLAGS "$src")" || return 1
            sources+=("$src_resolved")
        fi
    done

    # Show confirmation prompt
    echo "Moving:"
    for src in "${sources[@]}"; do
        echo -e "  - \033[34m$(basename "$src")\033[0m"
    done
    echo "To:"
    echo -e "  \033[1;36m${dest_resolved/#$HOME/~}\033[0m"
    echo
    read -p "Y/n: " confirm

    if [[ "$confirm" =~ ^[Nn] ]]; then
        echo "Cancelled"
        return 0
    fi

    # Clear confirmation output (Moving: + sources + To: + path + empty + Y/n)
    printf "\033[%dA\033[J" $((${#sources[@]} + 5))

    mv "${sources[@]}" "$dest_resolved" && {
        # Clean final output
        names=()
        for src in "${sources[@]}"; do names+=("$(basename "$src")"); done
        printf "Moved \033[34m%s\033[0m\n" "${names[*]}"
        printf " \033[1;36m→ %s\033[0m\n" "${dest_resolved/#$HOME/\~}"

        # Save undo data
        UNDO_DIR="/tmp/tx-undo-$USER"
        mkdir -p "$UNDO_DIR"
        printf '%s\n' "${sources[@]}" > "$UNDO_DIR/sources"
        echo "$dest_resolved" > "$UNDO_DIR/dest"
    }

elif [[ "$1" == "undo" ]]; then
    # Undo last move
    UNDO_DIR="/tmp/tx-undo-$USER"

    if [[ ! -f "$UNDO_DIR/sources" ]] || [[ ! -f "$UNDO_DIR/dest" ]]; then
        echo "tx: nothing to undo" >&2
        return 1
    fi

    # Read undo data
    mapfile -t undo_sources < "$UNDO_DIR/sources"
    undo_dest=$(cat "$UNDO_DIR/dest")

    # Build list of items to move back
    items_to_undo=()
    targets=()
    for src in "${undo_sources[@]}"; do
        item_name=$(basename "$src")
        item_path="$undo_dest/$item_name"
        if [[ -e "$item_path" ]]; then
            items_to_undo+=("$item_path")
            targets+=("$src")
        else
            echo "tx: warning: $item_name not found in $undo_dest" >&2
        fi
    done

    if [[ ${#items_to_undo[@]} -eq 0 ]]; then
        echo "tx: nothing to undo (files not found)" >&2
        return 1
    fi

    # Show confirmation
    echo "Undoing:"
    for item in "${items_to_undo[@]}"; do
        echo -e "  - \033[34m$(basename "$item")\033[0m"
    done
    echo "Back to:"
    echo -e "  \033[1;36m${targets[0]%/*}\033[0m"
    echo
    read -p "Y/n: " confirm

    if [[ "$confirm" =~ ^[Nn] ]]; then
        echo "Cancelled"
        return 0
    fi

    # Clear confirmation output (Undoing: + items + Back to: + path + empty + Y/n)
    printf "\033[%dA\033[J" $((${#items_to_undo[@]} + 5))

    # Move items back to original locations
    names=()
    for i in "${!items_to_undo[@]}"; do
        item="${items_to_undo[$i]}"
        target="${targets[$i]}"
        mv "$item" "$target"
        names+=("$(basename "$item")")
    done

    printf "Undone \033[34m%s\033[0m\n" "${names[*]}"
    printf " \033[1;36m→ %s\033[0m\n" "${targets[0]%/*}"

    # Clear undo data
    rm -f "$UNDO_DIR/sources" "$UNDO_DIR/dest"

elif [[ $# -eq 1 ]]; then
    # Navigate: resolve path and cd
    target="$($LIBDIR/nav-engine.sh $NAV_FLAGS "$1")" || return 1
    if cd "$target" && [[ "$OLDPWD" != "$PWD" ]]; then
        echo "→ $(pwd)"
    fi

else
    # No args: show help
    echo "w=workspace t=tools f=foreign h=homemade c=config b=bin sb=sysbin lb=localbin"
fi
