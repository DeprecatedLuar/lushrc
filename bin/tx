#!/usr/bin/env bash
# tx (taxi) - quick directory navigation and file transport

# Parse flags
NAV_FLAGS=""
while [[ "$1" == --* ]]; do
    case "$1" in
        --log) NAV_FLAGS="--log"; shift ;;
        *) shift ;;
    esac
done

if [[ $# -ge 2 ]]; then
    # Move file(s): last arg is destination, all others are sources
    dest="${!#}"
    dest_resolved="$($LIBDIR/nav-engine.sh $NAV_FLAGS "$dest")" || return 1

    sources=()
    for ((i=1; i<$#; i++)); do
        src="${!i}"

        # Handle glob patterns (e.g., d/*, t/foo/*)
        if [[ "$src" == */* ]] && [[ "$src" =~ [*?] ]] && [[ ! -e "$src" ]]; then
            base_query="${src%%/*}"
            pattern="${src#*/}"

            # Resolve base path
            base_resolved="$($LIBDIR/nav-engine.sh $NAV_FLAGS "$base_query")" || return 1

            # Expand glob in resolved path
            shopt -s nullglob
            expanded=("$base_resolved"/$pattern)
            shopt -u nullglob

            if [[ ${#expanded[@]} -eq 0 ]]; then
                echo "tx: no matches found for '$src'" >&2
                return 1
            fi

            sources+=("${expanded[@]}")
        else
            # Normal path resolution
            src_resolved="$($LIBDIR/nav-engine.sh $NAV_FLAGS "$src")" || return 1
            sources+=("$src_resolved")
        fi
    done

    # Show confirmation prompt
    echo "Picking up:"
    for src in "${sources[@]}"; do
        echo -e "  - \033[34m$(basename "$src")\033[0m"
    done
    echo "To:"
    echo -e "\033[1;33m${dest_resolved/#$HOME/~}\033[0m"
    echo
    read -p "Y/n: " confirm

    if [[ "$confirm" =~ ^[Nn] ]]; then
        echo "Cancelled"
        return 0
    fi

    mv "${sources[@]}" "$dest_resolved" && echo "→ $dest_resolved"

elif [[ $# -eq 1 ]]; then
    # Navigate: resolve path and cd
    target="$($LIBDIR/nav-engine.sh $NAV_FLAGS "$1")" || return 1
    if cd "$target" && [[ "$OLDPWD" != "$PWD" ]]; then
        echo "→ $(pwd)"
    fi

else
    # No args: show help
    echo "w=workspace t=tools f=foreign h=homemade c=config b=bin sb=sysbin lb=localbin"
fi
